#!python
import argparse
import os, sys, django
from pathlib import Path

settings_path = Path(__file__).parent / ".." / "pydaddy"
sys.path.append(str(settings_path.absolute()))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'eagledaddy.settings')
django.setup()

from tabulate import tabulate

from digi.xbee.devices import DigiMeshDevice
from pydaddy.models import RemoteModule
from pydaddy.hub import HubModule

parser = argparse.ArgumentParser()
parser.add_argument("-d",
                    "--discover-network",
                    help="Discovers newly found network",
                    action='store_true')

parser.add_argument("-l",
                    "--list",
                    help="Shows stored modules",
                    action='store_true')

if __name__ == '__main__':
    args = parser.parse_args()
    hub = HubModule()
    if args.discover_network:
        hub.discover_all_devices()

    elif args.list:
        devices = [(x.node_id, x.address64.hex(), x.network_id.hex(),
                    x.parent_device.hex()) for x in RemoteModule.objects.all()]
        print(
            tabulate(devices,
                     headers=['Node ID', "MAC", "Network ID", "Hub MAC"],
                     tablefmt="fancy_grid"))
